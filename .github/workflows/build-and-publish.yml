name: Build and Publish

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            variant: linux-amd64
          - os: ubuntu-24.04-arm
            variant: linux-arm64
          - os: macos-15
            variant: darwin-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build modules
        run: |
          set -euo pipefail

          modules=$(git config --file .gitmodules --get-regexp path | awk '{print $2}')
          mkdir -p build-output

          for module in $modules; do
            echo "=== Building $module ==="
            if (cd "$module" && nix bundle --bundler github:logos-co/nix-bundle-dir#permissive -o result .#lib); then
              echo "Built $module"
              mkdir -p "build-output/${module}"
              cp -rL "$module/result/." "build-output/${module}/"
            else
              echo "::warning::Failed to build $module on ${{ matrix.variant }}"
            fi
          done

      - uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.variant }}
          path: build-output/
          retention-days: 1

  package:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build lgx tool
        run: |
          nix build .#lgx
          echo "LGX=$(readlink -f result/bin/lgx)" >> "$GITHUB_ENV"

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package modules
        run: |
          export ARTIFACTS_DIR="artifacts"
          bash ci/package-modules.sh

      - name: Generate release table
        id: table
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json

          with open("output/list.json") as f:
              modules = json.load(f)

          all_variants = ["linux-amd64", "linux-arm64", "darwin-amd64", "darwin-arm64"]
          header = "| Module | " + " | ".join(all_variants) + " |"
          sep = "|--------|" + "|".join([":---:" for _ in all_variants]) + "|"

          rows = []
          for m in modules:
              name = m.get("moduleName", m.get("name", ""))
              version = m.get("version", "")
              label = f"{name} v{version}" if version else name
              variants = set(m.get("variants", []))
              cells = " | ".join("\u2705" if v in variants else "\u274c" for v in all_variants)
              rows.append(f"| {label} | {cells} |")

          table = "\n".join([header, sep] + rows)

          # Use multiline output
          import os
          delim = "EOF_TABLE"
          print(f"table<<{delim}")
          print(table)
          print(delim)
          PY

      - name: Prepare release tag
        id: tag
        run: |
          short_sha="${GITHUB_SHA::7}"
          date_str="$(date -u +%Y%m%d)"
          tag="build-${date_str}-${short_sha}"
          name="Build $(date -u +%Y-%m-%d) (${short_sha})"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "name=$name" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.name }}
          body: |
            Automated build from ${{ github.sha }}

            ## Module Availability

            ${{ steps.table.outputs.table }}
          files: |
            output/*.lgx
            output/list.json
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
